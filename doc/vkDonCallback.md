# VK Don Callback - Отслеживание статуса подписки

Данный функционал отвечает за автоматическое обновление флага `isDon` пользователя в зависимости от статуса его подписки VK DON и приходящих событий от ВКонтакте.

## Логика работы

### События, при которых устанавливается `isDon = true`:
- `donut_subscription_create` - создание новой подписки
- `donut_subscription_prolonged` - продление подписки

### События, при которых устанавливается `isDon = false`:
- `donut_subscription_expired` - истечение подписки
- `donut_subscription_cancelled` - отмена подписки

### События, которые не изменяют статус `isDon`:
- `donut_subscription_price_changed` - изменение стоимости подписки (только добавляет boost)

## Текущая реализация

Обработка событий происходит в файле `packages/back/src/modules/controllers/callback.controller.ts` в функции `callbackHandler`.

### Обрабатываемые типы событий:

1. **donut_subscription_create** - пользователь оформил подписку
   - Устанавливает `isDon = true`
   - Добавляет boost согласно сумме доната
   - Выполняет дополнительную синхронизацию через 1 секунду

2. **donut_subscription_prolonged** - пользователь продлил подписку
   - Устанавливает `isDon = true`
   - Добавляет boost согласно сумме доната
   - Выполняет дополнительную синхронизацию через 1 секунду

3. **donut_subscription_price_changed** - изменение цены подписки
   - Не изменяет статус `isDon`
   - Добавляет boost согласно разнице в цене

4. **donut_subscription_expired** - подписка истекла
   - Устанавливает `isDon = false`
   - Выполняет дополнительную синхронизацию через 1 секунду

5. **donut_subscription_cancelled** - подписка отменена
   - Устанавливает `isDon = false`
   - Выполняет дополнительную синхронизация через 1 секунду

## Дополнительная функциональность

### API для ручной синхронизации

Добавлен API эндпоинт для ручной синхронизации статуса подписки:

```
POST /users/:id/sync-don-status/
```

**Описание:** Проверяет актуальный статус подписки пользователя через VK API и синхронизирует его с базой данных.

**Параметры:**
- `id` - ID пользователя в системе

**Ответ:**
```json
{
  "success": true,
  "isDon": true,
  "message": "DON status synchronized for user 123456"
}
```

**Права доступа:** 
- Пользователь может синхронизировать только свой статус
- Администраторы могут синхронизировать статус любого пользователя

### Сервис синхронизации

Реализован сервис `don.service.ts` с функциями:

1. **syncUserDonStatus(vkId)** - синхронизация статуса для конкретного пользователя
2. **syncAllDonStatuses()** - заготовка для массовой синхронизации (не реализована)

### VK API интеграция

Добавлена функция `checkDonutSubscription(userId)` в `vk-api.ts` для проверки актуального статуса подписки через VK API.

## Схема данных

Флаг `isDon` хранится в таблице `User` в базе данных:
- Тип: `Boolean`
- Значение по умолчанию: `false`
- Индексация: добавлен индекс `@@index([isDon])` для быстрого поиска

## Логирование

- Все события сохраняются в таблицу `VkCallbackEvent` для возможности аудита и отладки
- Добавлено подробное логирование в консоль с префиксом `[DON]` для событий callback
- Логирование операций синхронизации с префиксом `[DON SERVICE]`
- Логирование VK API запросов с префиксом `[VK API]`

## Файлы, задействованные в функционале:

1. `packages/back/src/modules/controllers/callback.controller.ts` - обработка событий VK
2. `packages/back/src/modules/services/don.service.ts` - сервис синхронизации
3. `packages/back/src/modules/controllers/user.controller.ts` - API контроллер
4. `packages/back/src/modules/routers/user.router.ts` - роутинг
5. `packages/back/src/api/vk-api.ts` - интеграция с VK API
6. `packages/back/prisma/schema.prisma` - схема БД с индексом
